<template>
  <div
    v-for="item in constructedItems"
    :key="item.id"
    data-slot="animated-tooltip"
    class="group relative -mr-4"
    @mouseenter="(e) => handleMouseEnter(e, item.id)"
    @mouseleave="hoveredIndex = null"
    @mousemove="handleMouseMove"
  >
    <!-- Tooltip -->
    <Motion
      v-if="hoveredIndex === item.id"
      :initial="{
        opacity: 0,
        y: 20,
        scale: 0.6,
      }"
      :animate="{
        opacity: 1,
        y: 0,
        scale: 1,
      }"
      :transition="{
        type: 'spring',
        stiffness: 260,
        damping: 10,
      }"
      :exit="{
        opacity: 0,
        y: 20,
        scale: 0.6,
      }"
      :style="{
        translateX: `${translation}px`,
        rotate: `${rotation}deg`,
      }"
      class="absolute -top-16 left-1/2 z-50 flex -translate-x-1/2 flex-col items-center justify-center rounded-md bg-black px-4 py-2 text-xs whitespace-nowrap shadow-xl"
    >
      <div
        class="absolute right-1/2 -bottom-px z-30 me-1 h-px w-2/5 translate-x-1/2 bg-linear-to-r from-transparent via-emerald-500 to-transparent"
      />
      <div
        class="absolute -bottom-px left-1/2 z-30 ms-1 h-px w-2/5 -translate-x-1/2 bg-linear-to-r from-transparent via-sky-500 to-transparent"
      />
      <div class="relative z-30 text-base font-bold text-white">
        {{ item.title }}
      </div>
      <div v-if="item.description" class="text-xs text-white">{{ item.description }}</div>
    </Motion>

    <!-- Avatar Image -->
    <img
      data-slot="avatar"
      :src="item.image"
      :alt="item.title"
      class="relative m-0! size-14 rounded-full border-2 border-white object-cover object-top p-0! transition duration-500 group-hover:z-30 group-hover:scale-105"
    />
  </div>
</template>

<script setup lang="ts">
  import { Motion } from "motion-v";

  interface Item {
    /**
     * Unique identifier for the item
     *
     * If not provided, an ID will be generated
     */
    id?: string;
    /**
     * Title of the item (e.g., name)
     */
    title: string;
    /**
     * Description of the item (e.g., role or position)
     */
    description?: string;
    /**
     * URL of the avatar image
     */
    image: string;
  }

  const props = defineProps<{
    items: Item[];
  }>();

  // create ids for items
  const constructedItems = props.items.map((item) => ({
    ...item,
    id: item.id || useId(),
  }));

  const hoveredIndex = ref<string | null>(null);
  const mouseX = ref<number>(0);

  // Calculate rotation and translation based on mouse position
  const rotation = computed<number>(() => {
    const x = mouseX.value;
    return (x / 100) * 50;
  });

  const translation = computed<number>(() => {
    const x = mouseX.value;
    return (x / 100) * 50;
  });

  // Handle initial mouse position and hover
  function handleMouseEnter(event: MouseEvent, itemId: string) {
    hoveredIndex.value = itemId;
    // Calculate initial position immediately
    const rect = (event.target as HTMLElement)?.getBoundingClientRect();
    const halfWidth = rect.width / 2;
    mouseX.value = event.clientX - rect.left - halfWidth;
  }

  // Handle mouse movement
  function handleMouseMove(event: MouseEvent) {
    const rect = (event.target as HTMLElement)?.getBoundingClientRect();
    const halfWidth = rect.width / 2;
    mouseX.value = event.clientX - rect.left - halfWidth;
  }
</script>
